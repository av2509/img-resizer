from flask import Flask, render_template, request, send_file, jsonify
from PIL import Image
import PyPDF2
from reportlab.pdfgen import canvas
from reportlab.lib.pagesizes import letter, A4
import os
import uuid
from werkzeug.utils import secure_filename
import tempfile
import zipfile

app = Flask(__name__)
app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024  # 16MB max file size
app.config['UPLOAD_FOLDER'] = 'uploads'
app.config['OUTPUT_FOLDER'] = 'outputs'

# Ensure directories exist
os.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)
os.makedirs(app.config['OUTPUT_FOLDER'], exist_ok=True)

ALLOWED_IMAGE_EXTENSIONS = {'png', 'jpg', 'jpeg', 'gif', 'bmp', 'tiff'}
ALLOWED_PDF_EXTENSIONS = {'pdf'}

def allowed_file(filename, allowed_extensions):
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in allowed_extensions

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/convert-to-pdf', methods=['POST'])
def convert_images_to_pdf():
    if 'files' not in request.files:
        return jsonify({'error': 'No files selected'}), 400
    
    files = request.files.getlist('files')
    if not files or files[0].filename == '':
        return jsonify({'error': 'No files selected'}), 400
    
    # Generate unique filename
    output_filename = f"converted_{uuid.uuid4().hex}.pdf"
    output_path = os.path.join(app.config['OUTPUT_FOLDER'], output_filename)
    
    try:
        images = []
        for file in files:
            if file and allowed_file(file.filename, ALLOWED_IMAGE_EXTENSIONS):
                # Save uploaded file temporarily
                temp_path = os.path.join(app.config['UPLOAD_FOLDER'], secure_filename(file.filename))
                file.save(temp_path)
                
                # Open and convert image
                img = Image.open(temp_path)
                if img.mode != 'RGB':
                    img = img.convert('RGB')
                images.append(img)
                
                # Clean up temp file
                os.remove(temp_path)
        
        if images:
            # Save as PDF
            images[0].save(output_path, save_all=True, append_images=images[1:])
            return send_file(output_path, as_attachment=True, download_name=output_filename)
        else:
            return jsonify({'error': 'No valid images found'}), 400
            
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/resize-image', methods=['POST'])
def resize_image():
    if 'file' not in request.files:
        return jsonify({'error': 'No file selected'}), 400
    
    file = request.files['file']
    width = int(request.form.get('width', 800))
    height = int(request.form.get('height', 600))
    
    if file.filename == '':
        return jsonify({'error': 'No file selected'}), 400
    
    if file and allowed_file(file.filename, ALLOWED_IMAGE_EXTENSIONS):
        try:
            # Process image
            img = Image.open(file.stream)
            resized_img = img.resize((width, height), Image.Resampling.LANCZOS)
            
            # Save resized image
            output_filename = f"resized_{uuid.uuid4().hex}.{file.filename.rsplit('.', 1)[1].lower()}"
            output_path = os.path.join(app.config['OUTPUT_FOLDER'], output_filename)
            resized_img.save(output_path)
            
            return send_file(output_path, as_attachment=True, download_name=output_filename)
            
        except Exception as e:
            return jsonify({'error': str(e)}), 500
    
    return jsonify({'error': 'Invalid file type'}), 400

if __name__ == '__main__':
    app.run(debug=True)
